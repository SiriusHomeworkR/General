---
title: "Environmental Legislation and its Effects on Air Quality"
author: "Group 2"
output:
  ioslides_presentation: default
  beamer_presentation:
    slide_level: 3
    theme: Boadilla
  slidy_presentation: default
header-includes:
- \AtBeginSection[]{\begin{frame}\tableofcontents[currentsection]\end{frame}}
- \AtBeginSubsection[]{\begin{frame}\tableofcontents[currentsubsection]\end{frame}{}}
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, cache = T, fig.width=8, fig.height=4,
                      warning = F, width = 60)
options(scipen = 0, digits = 3)

if(!require('pacman')) install.packages('pacman')

pacman::p_load(Rcpp, geofacet, tidyverse, dplyr, ggplot2, data.table, lubridate, plotROC, usmap, glmnet, 
               plotly, haven, magrittr, Stat2Data, skimr, GGally, rvest, gridExtra, scales, usdata, party, car)
```

## Introduction

The goal of this study is to examine the impact of certain variables on the climate 
by examining the AQI of counties across the United States of America using data collected
by the EPA.

There are two smaller sub studies in this presentation: One examining the effects of
the Climate Alliance legislative program, and another examining the correlation between
aspects of counties and the air quality.



## Reading the Data and EDA

---
\frametitle{Read and Clean}

To begin we read the data in from the EPA datasets.

\tiny
``` {r readin, results = F}

data2020 <- fread("data/annual_aqi_by_county_2020.csv", stringsAsFactors = TRUE)
data2019 <- fread("data/annual_aqi_by_county_2019.csv", stringsAsFactors = TRUE)
data2018 <- fread("data/annual_aqi_by_county_2018.csv", stringsAsFactors = TRUE)
data2017 <- fread("data/annual_aqi_by_county_2017.csv", stringsAsFactors = TRUE)
data2016 <- fread("data/annual_aqi_by_county_2016.csv", stringsAsFactors = TRUE)
data2015 <- fread("data/annual_aqi_by_county_2015.csv", stringsAsFactors = TRUE)
data2014 <- fread("data/annual_aqi_by_county_2014.csv", stringsAsFactors = TRUE)
data2013 <- fread("data/annual_aqi_by_county_2013.csv", stringsAsFactors = TRUE)
data2012 <- fread("data/annual_aqi_by_county_2012.csv", stringsAsFactors = TRUE)
data2011 <- fread("data/annual_aqi_by_county_2011.csv", stringsAsFactors = TRUE)
data2010 <- fread("data/annual_aqi_by_county_2010.csv", stringsAsFactors = TRUE)

raw_data <- rbind(data2020, data2019, data2018, data2017, data2016,
                  data2015, data2014, data2013, data2012, data2011, data2010)





raw_data <- raw_data %>% rename(
  num.days = `Days with AQI`,
  good.days = `Good Days`,
  mod.days = `Moderate Days`,
  sens.group.days = `Unhealthy for Sensitive Groups Days`,
  unhlthy.days = `Unhealthy Days`,
  very.unhlthy.days = `Very Unhealthy Days`,
  haz.days = `Hazardous Days`,
  max.aqi = `Max AQI`,
  med.aqi = `Median AQI`,
  state = State
)

raw_data$is.climate.alli <- "no"

raw_data[raw_data$state %in% c("California", "Colorado", "Connecticut", "Delaware",
                               "Hawaii", "Illinois", "Louisiana", "Maine", "Maryland",
                               "Massachucets", "Michigan", "Minnesota", "Nevada",
                               "New Jersey", "New Mexico", "New York", "North Carolina",
                               "Oregon", "Pennsylvania", "Puerto Rico", "Rhode Island",
                               "Vermont", "Virginia", "Washington", "Wisconsin"
                               ), c("is.climate.alli")] <- "yes"


raw_data <- raw_data %>%
  mutate(good.pct = good.days/num.days*100,
         mod.pct = mod.days/num.days*100,
         sens.group.pct = sens.group.days/num.days*100,
         unhlthy.pct = unhlthy.days/num.days*100,
         very.unhlthy.pct = very.unhlthy.days/num.days*100,
         haz.pct = haz.days/num.days*100)

mean.state.df <- raw_data %>% group_by(state, Year) %>% summarize(mean.state = mean(med.aqi),
                                                                  peak.state = max(max.aqi))

raw_data <- merge(raw_data, mean.state.df, by=c("state", "Year"))

subbed_data <- raw_data %>% select(state, Year, County, num.days, max.aqi, med.aqi,
                                   good.pct, mod.pct, sens.group.pct, unhlthy.pct,
                                   very.unhlthy.pct, haz.pct, mean.state, is.climate.alli)

```


---
\frametitle{Heatmap}
```{r heatmap}

plot_usmap(regions = "state",                   
           #regions = "counties", for county level summary
           data = mean.state.df,
           values = "mean.state", exclude = c("District of Columbia", "Country of Mexico",
                                                     "Virgin Islands", "Puerto Rico")
           , color = "black") + 
  scale_fill_gradient(
    low = "white", high = "red", 
    name = "AQI", 
    label = scales::comma) + 
  labs(title = "state Avg AQI") +
  theme(legend.position = "right") +
  facet_wrap(~ Year)

```

---
\frametitle{AQI by Year Faceted by State}

``` {r facetAqi}

raw_data %>%
ggplot(aes(x = Year, y = mean.state, group=state,color = state)) +
  geom_line() +
  facet_wrap(~state) +
  theme_bw() +
  theme(legend.position = 0) +
  ggtitle("`State`vs`Avg AQI")

```

## Climate Alliance

---
\frametitle{Linear Regression}

``` {r LinearRegression}
subbed_data$is.climate.alli <- as.factor(subbed_data$is.climate.alli)
focus_data <- subbed_data[subbed_data$Year %in% 2018:2019,]
summary(lm(data = focus_data, med.aqi ~ is.climate.alli + state))
```

---
\frametitle{Analysis}

Climate Alliance states tend to have a better AQI on average but it is not significant.  

This might be because the Climate Alliance only went into effect 3 years ago in 2017.

## County Level Effects on AQI

Using the data found by the USDAâ€™s Economic Research Service, we look for predictors in counties to determine air quality and find correlations.

This begins by merging the 2019 AQI with the latest USDA ERS data. We use 2019 data to avoid skewing due to the 2020 West Coast fires.

---
\frametitle{Merging AQI Data with County Data}

To begin the analysis, we start by merging county data with AQI data. We start by
merging all three sets of ERS county data, and then we merge by county and state.  

We only take the data from year 2019 to keep it consistent. We are avoiding using
2020 data due to the fires on the West coast skewing data.

\tiny
``` {r cleanmerge}
county_data_jobs <- fread("data/Release23_June2021/Jobs.csv")
county_data_people <- fread("data/Release23_June2021/People.csv")
county_data_income <- fread("data/Release23_June2021/Income.csv")


county_data_master <- merge(county_data_jobs, county_data_people, by = c("County", "FIPS", "State"))
county_data_master <- merge(county_data_master, county_data_income, by = c("County", "FIPS", "State"))
county_data_master$State <- abbr2state(county_data_master$State)
county_data_master <- county_data_master %>% rename(state = State)

dated_subbed_data <- subbed_data[subbed_data$Year == 2019,] %>% select(state, Year, County, med.aqi)

master_data <- merge(county_data_master, dated_subbed_data, by = c("County", "state"))

glmnet_data <- master_data %>% select(-County, -FIPS) %>% drop_na()
```


---
\frametitle{Running the LASSO Algorithm}

Break the cleaned and merged dataset into X and Y for use with cv.glmnet. We use
set.seed(1) for consistency.

\tiny
``` {r glmnet}

set.seed(1)

X <- model.matrix(med.aqi~., glmnet_data)[,-1]
y <- glmnet_data$med.aqi


fit.cv <- cv.glmnet(X, y, alpha = 1, nfolds = 10)

coeffs <- coef(fit.cv)
nonzeros <- rownames(as.matrix(coeffs[which(coeffs != 0), 0]))
non_state_intercept_coef <- nonzeros[10:length(nonzeros)]

select_cols <- c("state", "med.aqi", non_state_intercept_coef)
lm_cols <- glmnet_data %>% select(select_cols)

fit.lm <- lm(data = lm_cols, med.aqi ~ .)

Anova(fit.lm)

```


---
\frametitle{Backwards Selection with Anova}

From the Anova call above, we see that Age65AndOlderPct2010 is the least relevant, so
we remove it.

\tiny
``` {r anova1}
fit.backward.1 <- update(fit.lm, .~. -Age65AndOlderPct2010)
Anova(fit.backward.1)
```



---
\frametitle{Backwards Selection with Anova}

From the Anova call above, we see that PctEmpAgriculture is the least relevant, so
we remove it.

\tiny
``` {r anova2}
fit.backward.2 <- update(fit.backward.1, .~. - PctEmpAgriculture)
Anova(fit.backward.2)
```



---
\frametitle{Backwards Selection with Anova}

From the Anova call above, we see that PctEmpConstruction is the least relevant, so
we remove it.

\tiny
``` {r anova3}
fit.backward.3 <- update(fit.backward.2, .~. - PctEmpConstruction)
Anova(fit.backward.3)
fit.final <- fit.backward.3
```




---
\frametitle{Examining the Final Fit - Do the Assumptions of the Linear Model Hold Up?}


\tiny
``` {r finalFit, size = "tiny"}

temp <- summary(fit.final)$coefficients[, c("Estimate")]
non_states <- summary(fit.final)$coefficients[50:length(temp),]

non_states

```

From the final model, we see that most of the impact on AQI is geographical. For example, 
the increase from ForeignBornMexNum and NetMigrationNum could signal that states closer to
the Mexican border tend to have worse AQIs due to their location. However, the
most clear predictors are the states themselves.

The assumptions for linearity appear to hold up until about 1 standard deviation below
the mean.


---
\frametitle{Diagnostic Plots}

``` {r plots, fig.show="hold", out.width="50%"}

plot(fit.final, 1)
plot(fit.final, 2)

```
## Conclusion

The overall objective of this study was to use the AQI of counties across the USA to determine the impact of variables on the climate. Using data collected by the EPA, we were able to focus on the effect of the Climate Alliance on curbing the deterioration of the AQI across the nation, as well as the correlation between aspects of counties and their air quality.

From this study, we were able to conclude that the Climate Alliance has not had much of an effect yet on the AQI of member states, but do have better AQIs on average compared to other states. We were also able to see that most of the impact on the AQI is geographical based on the significant variables of the model. 

